!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("RasterToGcode",[],t):"object"==typeof exports?exports.RasterToGcode=t():e.RasterToGcode=t()}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.RasterToGcode=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,i,n)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(n)},u=i(2),c=n(u),f=function(e){function t(e){r(this,t),e=Object.assign({ppi:{x:254,y:254},toolDiameter:.1,rapidRate:1500,feedRate:500,rateUnit:"mm/min",beamRange:{min:0,max:1},beamPower:{min:0,max:100},milling:!1,zSafe:5,zSurface:0,zDepth:-10,passDepth:1,offsets:{X:0,Y:0},trimLine:!0,joinPixel:!0,burnWhite:!0,verboseG:!1,diagonal:!1,overscan:0,precision:{X:2,Y:2,S:4},nonBlocking:!0,filters:{smoothing:0,brightness:0,contrast:0,gamma:0,grayscale:"none",shadesOfGray:256,invertColor:!1},onProgress:null,onProgressContext:null,onDone:null,onDoneContext:null,onAbort:null,onAbortContext:null},e||{});var i=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));if(i.milling){if(i.zSafe<i.zSurface)throw new Error('"zSafe" must be greater to "zSurface"');i.passes=Math.abs(Math.floor(i.zDepth/i.passDepth))}if(i.toolDiameter<=0)throw new Error('"toolDiameter" must be positive');return i.ppi.x||(i.ppi={x:i.ppi,y:i.ppi}),i.ppm={x:parseFloat((2540/(100*i.ppi.x)).toFixed(10)),y:parseFloat((2540/(100*i.ppi.y)).toFixed(10))},i.scaleRatio={x:i.ppm.x/i.toolDiameter,y:i.ppm.y/i.toolDiameter},i.running=!1,i.gcode=null,i.gcodes=null,i.currentLine=null,i.lastCommands=null,i.outputSize={width:0,height:0},i.G1=["G",1],i.G0=["G",i.burnWhite?1:0],i.beamOffset=1e3*i.toolDiameter/2e3,i.realBeamRange={min:i.beamRange.max/100*i.beamPower.min,max:i.beamRange.max/100*i.beamPower.max},"mm/sec"===i.rateUnit&&(i.feedRate*=60,i.rapidRate!==!1&&(i.rapidRate*=60)),i._registerUserCallbacks(i),i}return s(t,e),h(t,[{key:"_registerUserCallbacks",value:function(e){e.onProgress&&this.on("progress",e.onProgress,e.onProgressContext),e.onAbort&&this.on("abort",e.onAbort,e.onAbortContext),e.onDone&&this.on("done",e.onDone,e.onDoneContext)}},{key:"_processImage",value:function(){l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_processImage",this).call(this),this.outputSize={width:this.size.width*(1e3*this.toolDiameter)/1e3,height:this.size.height*(1e3*this.toolDiameter)/1e3}}},{key:"abort",value:function(){this.running=!1}},{key:"run",value:function(e){if(!this.running){this.running=!0,this.gcode=[],this.gcodes=[],this.lastCommands={},this.currentLine=null,e=e||{},this._registerUserCallbacks(e);var t=this.nonBlocking;return void 0!==e.nonBlocking&&(t=e.nonBlocking),this._addHeader(),this.diagonal?this._scanDiagonally(t):this._scanHorizontally(t),t?void 0:this.gcode}}},{key:"_addHeader",value:function(){this.gcode.push("; Generated by LaserWeb (lw.raster-to-gcode.js)","; Size       : "+this.outputSize.width+" x "+this.outputSize.height+" mm","; PPI        : x: "+this.ppi.x+" - y: "+this.ppi.y,"; PPM        : x: "+this.ppm.x+" - y: "+this.ppm.y,"; Tool diam. : "+this.toolDiameter+" mm","; Rapid rate : "+(this.rapidRate!==!1?this.rapidRate+" "+this.rateUnit:"inherit"),"; Feed rate  : "+this.feedRate+" "+this.rateUnit),this.milling?this.gcode.push("; Z safe     : "+this.zSafe,"; Z surface  : "+this.zSurface,"; Z depth    : "+this.zDepth):this.gcode.push("; Beam range : "+this.beamRange.min+" to "+this.beamRange.max,"; Beam power : "+this.beamPower.min+" to "+this.beamPower.max+" %");for(var e=["smoothing","trimLine","joinPixel","burnWhite","verboseG","diagonal"],t=e.length-1;t>=0;t--)this[e[t]]||e.splice(t,1);e.length&&this.gcode.push("; Options    : "+e.join(", ")),this.gcode.push(""),this.rapidRate!==!1&&this.gcode.push("G0 F"+this.rapidRate),this.gcode.push("G1 F"+this.feedRate),this.gcode.push("")}},{key:"_mapPixelPower",value:function(e){var t=this.milling?{min:0,max:this.zDepth}:this.realBeamRange;return e*(t.max-t.min)/255+t.min}},{key:"_command",value:function(e,t){if("object"===("undefined"==typeof t?"undefined":a(t))){for(var i=Array.prototype.slice.call(arguments),n=void 0,r=[],o=0,s=i.length;o<s;o++)n=this._command.apply(this,i[o]),n&&r.push(n);return r.length?r.join(" "):null}return t=t.toFixed(this.precision[e]||0),this.verboseG||t!==this.lastCommands[e]?(this.lastCommands[e]=t,e+t):null}},{key:"_getPixelPower",value:function(e,t,i){try{t=this.size.height-t-1;var n=this.getPixel(e,t);return 255-n.gray}catch(e){if(3===arguments.length)return i;throw e}}},{key:"_getPoint",value:function(e){var t=this.currentLine[e];return t?(t.G=t.s?["G",1]:this.G0,t.X=t.x*this.toolDiameter+this.offsets.X,t.Y=t.y*this.toolDiameter+this.offsets.Y,t.S=this._mapPixelPower(t.s),this.diagonal?(t.Y+=this.toolDiameter,t.first||t.lastWhite?(t.X+=this.beamOffset,t.Y-=this.beamOffset):(t.last||t.lastColored)&&(t.X-=this.beamOffset,t.Y+=this.beamOffset)):(t.Y+=this.beamOffset,t.first||t.lastWhite?t.X+=this.beamOffset:(t.last||t.lastColored)&&(t.X-=this.beamOffset)),t):null}},{key:"_trimCurrentLine",value:function(){for(var e=this.currentLine[0];e&&!e.p;)this.currentLine.shift(),e=this.currentLine[0];for(e=this.currentLine[this.currentLine.length-2];e&&!e.p;)this.currentLine.pop(),e=this.currentLine[this.currentLine.length-2];return this.currentLine.length}},{key:"_reduceCurrentLine",value:function(){if(this.currentLine.length<3)return this.currentLine.length;for(var e,t=this.currentLine.splice(1),i=this.currentLine[0].p,n=0,r=t.length-1;n<r;n++)e=t[n],i!==e.p&&this.currentLine.push(e),i=e.p;this.currentLine.push(t[n])}},{key:"_overscanCurrentLine",value:function(e){var t=this.overscan/this.ppm.x,i=this.currentLine[0],n=this.currentLine[this.currentLine.length-1];i.s&&(i.lastWhite=!0),n.s&&(n.lastColored=!0),e?n.s=0:i.s=0;var r={x:n.x+t,y:n.y,s:0,p:0},o={x:i.x-t,y:i.y,s:0,p:0};this.diagonal&&(o.y+=t,r.y-=t),this.currentLine.unshift(o),this.currentLine.push(r)}},{key:"_processCurrentLine",value:function(e){return this.milling?this._processMillingLine(e):this._processLaserLine(e)}},{key:"_processMillingLine",value:function(e){var t=this;if(!this._trimCurrentLine())return null;this.joinPixel&&this._reduceCurrentLine(),this.currentLine[0].first=!0,this.currentLine[this.currentLine.length-1].last=!0,e&&(this.currentLine=this.currentLine.reverse());var i=void 0,n=0,r=void 0,o=[],s=function(){r=t._command.apply(t,arguments),r&&o.push(r)};i=this._getPoint(n);for(var a=!1,h=void 0,l=void 0,u=function(e){for(s(["G",0],["Z",t.zSafe]),s(["G",0],["X",i.X],["Y",i.Y]),s(["G",0],["Z",t.zSurface]);i;)i.S?(a&&(s(["G",0],["Z",t.zSurface]),a=!1),h=i.S,l=t.passDepth*e,e<t.passes&&(h=Math.max(h,-l)),s(["G",1],["Z",t.zSurface+h]),s(["G",1],["X",i.X],["Y",i.Y])):(a&&(s(["G",1],["Z",t.zSurface]),a=!1),s(["G",0],["Z",t.zSafe]),s(["G",0],["X",i.X],["Y",i.Y])),(i.lastWhite||i.lastColored)&&(a=!0),i=t._getPoint(++n);s(["G",1],["Z",t.zSurface]),s(["G",0],["Z",t.zSafe])},c=1;c<=this.passes&&(u(c),o.length);c++)this.gcodes.length<c?this.gcodes.push([]):this.gcodes[c-1].push.apply(this.gcodes[c-1],o),n=0,o=[],i=this._getPoint(n),this.lastCommands={};return null}},{key:"_processLaserLine",value:function(e){var t=this;if(this.trimLine&&!this._trimCurrentLine())return null;this.joinPixel&&this._reduceCurrentLine(),this.overscan&&this._overscanCurrentLine(e),this.currentLine[0].first=!0,this.currentLine[this.currentLine.length-1].last=!0,e&&(this.currentLine=this.currentLine.reverse());var i=void 0,n=0,r=void 0,o=[],s=function(){r=t._command.apply(t,arguments),r&&o.push(r)};for(i=this._getPoint(n),s(this.G0,["X",i.X],["Y",i.Y],["S",0]);i;)s(i.G,["X",i.X],["Y",i.Y],["S",i.S]),i=this._getPoint(++n);return o.length?o:null}},{key:"_scanHorizontally",value:function(e){var t=this,i=0,n=0,r=void 0,o=void 0,s=void 0,a=void 0,h=this.size.width,l=this.size.height,u=!1,c=!1,f=!1,p=function(){for(t.currentLine=[],s=null,i=0;i<=h;i++)r=o=t._getPixelPower(i,n,o),c=s&&!s.p&&o,f=s&&s.p&&!o,!u&&s&&(r=s.p),s={x:i,y:n,s:r,p:o},c&&(s.lastWhite=!0),f&&(s.lastColored=!0),t.currentLine.push(s)},d=0,g=0,m=function(){a=t._processCurrentLine(u),d=Math.round(n/l*100),d>g&&t._onProgress({gcode:a,percent:d}),g=d,a&&(u=!u,t.gcode.push.apply(t.gcode,a))},v=function i(){return t.running?(p(),m(),n++,void(n<l?e?setTimeout(i,0):i():(t.milling&&t.gcodes.forEach(function(e){t.gcode.push.apply(t.gcode,e)}),t._onDone({gcode:t.gcode}),t.running=!1))):t._onAbort()};v()}},{key:"_scanDiagonally",value:function(e){var t=this,i=0,n=0,r=void 0,o=void 0,s=void 0,a=void 0,h=this.size.width,l=this.size.height,u=h+l-1,c=0,f=!1,p=!1,d=!1,g=function(e,i){for(t.currentLine=[],s=null,c++;;){if(i<-1||i==l)break;if(e<0||e>h)break;r=o=t._getPixelPower(e,i,o),p=s&&!s.p&&o,d=s&&s.p&&!o,!f&&s&&(r=s.p),s={x:e,y:i,s:r,p:o},p&&(s.lastWhite=!0),d&&(s.lastColored=!0),t.currentLine.push(s),e++,i--}},m=0,v=0,y=function(){a=t._processCurrentLine(f),m=Math.round(c/u*100),m>v&&t._onProgress({gcode:a,percent:m}),v=m,a&&(f=!f,t.gcode.push.apply(t.gcode,a))},b=function r(){return t.running?(g(i,n),y(),i?i++:n++,n===l&&(i++,n--),void(n<l&&i<h?e?setTimeout(r,0):r():(t._onDone({gcode:t.gcode}),t.running=!1))):t._onAbort()};b()}},{key:"_onProgress",value:function(e){}},{key:"_onDone",value:function(e){}},{key:"_onAbort",value:function(){}},{key:"on",value:function(e,t,i){var n=this,r="_on"+e[0].toUpperCase()+e.slice(1);if(!this[r]||"function"!=typeof this[r])throw new Error("Undefined event: "+e);return this[r]=function(e){return t.call(i||n,e)},this}},{key:"getHeightMap",value:function(e){var t=this;if(!this.running){this.running=!0;var i=[],n=0,r=0,o=this.size.width,s=this.size.height,a=0,h=0;e=e||{},this._registerUserCallbacks(e);var l=this.nonBlocking;void 0!==e.nonBlocking&&(l=e.nonBlocking);var u=function(){var e=[];for(n=0;n<o;n++)e.push(t._mapPixelPower(t._getPixelPower(n,r)));a=Math.round(r/s*100),a>h&&t._onProgress({pixels:e,percent:a}),h=a,i.push(e)},c=function e(){return t.running?(u(),r++,void(r<s?l?setTimeout(e,0):e():(t._onDone({heightMap:i}),t.running=!1))):t._onAbort()};return c(),l?void 0:i}}}]),t}(c.default);t.RasterToGcode=f,t.default=f},function(e,t,i){!function(t,i){e.exports=i()}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.CanvasGrid=void 0;var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),s=i(2),a=n(s),h=function(){function e(t){r(this,e),this.cellSize=1024,this.scaleRatio={x:1,y:1},this.filters={},Object.assign(this,t||{}),this.scaleRatio.x||(this.scaleRatio={x:this.scaleRatio,y:this.scaleRatio}),this.size={width:0,height:0,cols:0,rows:0},this.file=null,this.image=null,this.url=null,this.canvas=[],this.pixels=[]}return o(e,[{key:"load",value:function(e){return e instanceof File?this.loadFromFile(e):e instanceof Image?this.loadFromImage(e):"string"==typeof e||e instanceof URL?this.loadFromURL(e.trim()):Promise.reject(new Error("Unsupported input format."))}},{key:"_loadImage",value:function(e,t,i){var n=this,r=new Image;r.onload=function(e){n.loadFromImage(r).then(i).catch(t)},r.onerror=function(i){t(new Error("An error occurred while loading the image : "+e))},r.src=e}},{key:"loadFromFile",value:function(e){var t=this;return new Promise(function(i,n){e instanceof File||n(new Error("Input param must be a File object.")),t.file=e,t._loadImage(URL.createObjectURL(e),n,i)})}},{key:"loadFromURL",value:function(e){var t=this;return new Promise(function(i,n){e instanceof URL||"string"==typeof e||n(new Error("Input param must be a URL string or object."));var r=e instanceof URL?e:new URL(e);t.url=r,t._loadImage(r,n,i)})}},{key:"loadFromImage",value:function(e){var t=this;return new Promise(function(i,n){e instanceof Image||n(new Error("Input param must be a Image object.")),t.image=e,t._processImage(),i(t)})}},{key:"_processImage",value:function(){this.canvas=[],this.pixels=[];var e=Math.round(this.image.width*this.scaleRatio.x),t=Math.round(this.image.height*this.scaleRatio.y),i=Math.ceil(e/this.cellSize),n=Math.ceil(t/this.cellSize);this.size={width:e,height:t,cols:i,rows:n};var r=null,o=null,s=null,h=null,l=null,u=null,c=null,f=null,p=null;for(l=0;l<this.size.rows;l++){for(r=[],h=0;h<this.size.cols;h++)o=document.createElement("canvas"),0===h||h<this.size.cols-1?o.width=this.size.width<this.cellSize?this.size.width:this.cellSize:o.width=this.size.width%this.cellSize,0===l||l<this.size.rows-1?o.height=this.size.height<this.cellSize?this.size.height:this.cellSize:o.height=this.size.height%this.cellSize,s=o.getContext("2d"),s.fillStyle="white",s.fillRect(0,0,o.width,o.height),f=o.width/this.scaleRatio.x,p=o.height/this.scaleRatio.y,u=h*this.cellSize/this.scaleRatio.x,c=l*this.cellSize/this.scaleRatio.y,s.drawImage(this.image,u,c,f,p,0,0,o.width,o.height),(0,a.default)(o,this.filters),r.push(o);this.canvas.push(r)}}},{key:"getPixel",value:function(e,t){if(e=parseInt(e),t=parseInt(t),isNaN(e)||isNaN(t))throw new Error("[x, y] params must be Integer.");if(e<0||e>=this.size.width)throw new Error("Out of range: x = "+e+", max: "+this.size.width);if(t<0||t>=this.size.height)throw new Error("Out of range: y = "+t+", max: "+this.size.height);var i=parseInt(e/this.cellSize),n=parseInt(t/this.cellSize);i&&(e-=this.cellSize*i),n&&(t-=this.cellSize*n);var r=this.canvas[n][i],o=r.getContext("2d"),s=o.getImageData(e,t,1,1).data;return{color:{r:s[0],g:s[1],b:s[2],a:s[3]},gray:(s[0]+s[1]+s[2])/3,grid:{col:i,row:n},coords:{x:e,y:t}}}}]),e}();t.CanvasGrid=h,t.default=h},function(e,t,i){!function(t,i){e.exports=i()}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){e.exports=i(1)},function(e,t){"use strict";function i(e){return e<0?0:e>255?255:e}function n(e,t,n){n&&(e[t]=i(255-e[t]),e[t+1]=i(255-e[t+1]),e[t+2]=i(255-e[t+2]))}function r(e,t,n){void 0!==n&&(e[t]=i(e[t]+n),e[t+1]=i(e[t+1]+n),e[t+2]=i(e[t+2]+n))}function o(e,t,n){void 0!==n&&(e[t]=i(n*(e[t]-128)+128),e[t+1]=i(n*(e[t+1]-128)+128),e[t+2]=i(n*(e[t+2]-128)+128))}function s(e,t,n){void 0!==n&&(e[t]=i(Math.exp(Math.log(255*(e[t]/255))*n)),e[t+1]=i(Math.exp(Math.log(255*(e[t+1]/255))*n)),e[t+2]=i(Math.exp(Math.log(255*(e[t+2]/255))*n)))}function a(e,t,n,r){if(l.indexOf(n)===-1)throw new Error("Unsupported grayscale algorithm: "+n);if("none"===n)return null;var o=void 0,s=e[t],a=e[t+1],h=e[t+2];switch(n){case"average":o=(s+a+h)/3;break;case"luma":o=.3*s+.59*a+.11*h;break;case"luma-601":o=.299*s+.587*a+.114*h;break;case"luma-709":o=.2126*s+.7152*a+.0722*h;break;case"luma-240":o=.212*s+.701*a+.087*h;break;case"desaturation":o=(Math.max(s,a,h)+Math.min(s,a,h))/2;break;case"decomposition-min":o=Math.min(s,a,h);break;case"decomposition-max":o=Math.max(s,a,h);break;case"red-chanel":o=s;break;case"green-chanel":o=a;break;case"blue-chanel":o=h}void 0!==r&&(o=parseInt(o/r)*r),o=parseInt(o),e[t]=i(o),e[t+1]=i(o),e[t+2]=i(o)}function h(e,t){t=Object.assign({},{smoothing:!1,brightness:0,contrast:0,gamma:0,grayscale:"none",shadesOfGray:256,invertColor:!1},t||{});var i=e.getContext("2d");void 0!==i.imageSmoothingEnabled?i.imageSmoothingEnabled=t.smoothing:(i.mozImageSmoothingEnabled=t.smoothing,i.webkitImageSmoothingEnabled=t.smoothing,i.msImageSmoothingEnabled=t.smoothing,i.oImageSmoothingEnabled=t.smoothing);var h=i.getImageData(0,0,e.width,e.height),l=h.data,u=void 0,c=void 0,f=void 0,p=void 0;0!==t.contrast&&(u=259*(t.contrast+255)/(255*(259-t.contrast))),0!==t.brightness&&(c=t.brightness),0!==t.gamma&&(f=1/t.gamma),t.shadesOfGray>1&&t.shadesOfGray<256&&(p=255/(t.shadesOfGray-1));for(var d=0,g=l.length;d<g;d+=4)n(l,d,t.invertColor),r(l,d,c),o(l,d,u),s(l,d,f),a(l,d,t.grayscale,p);i.putImageData(h,0,0)}Object.defineProperty(t,"__esModule",{value:!0});var l=["none","average","desaturation","decomposition-min","decomposition-max","luma","luma-601","luma-709","luma-240","red-chanel","green-chanel","blue-chanel"];t.canvasFilters=h,t.default=h}])})}])})}])});
//# sourceMappingURL=lw.raster-to-gcode.min.js.map